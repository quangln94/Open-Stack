# Host aggregate

Để cấu hình host aggregates, `filter_scheduler.enabled_filters` phải có `AggregateInstanceExtraSpecsFilter` được thêm vào để lập lịch.

Trên máy chủ chạy dịch vụ `nova-scheduler` sửa file `/etc/nova/nova.conf` như sau:
```sh
[filter_scheduler]
enabled_filters=...,AggregateInstanceExtraSpecsFilter
```

## 1. Host aggregates sử dụng Flavor

Thực hiện phân chia các loại máy chủ với các dòng CPU khác nhau

- Tạo Host aggregate `cpu-new` và `cpu-old` 
```sh
openstack aggregate create --zone nova cpu-new
openstack aggregate create --zone nova cpu-old
```

- Set property cho Host aggregate
```sh
openstack aggregate set --property cpu=new cpu-new
openstack aggregate set --property cpu=old cpu-old
```
- Add Node compute vào host-aggregate
```sh
openstack aggregate add host cpu-new compute04
```
```sh
openstack aggregate add host cpu-old compute01
openstack aggregate add host cpu-old compute02
openstack aggregate add host cpu-old compute03
```
- Thêm property cho Flavor để các máy ảo sử dụng Flavor này sẽ được tạo trên Node Compute tương ứng với Flavor đó. `property` của Flavor và Host aggregate phải giống nhau.
```sh
openstack flavor create --id 6 --ram 8192 --disk 80 --vcpus 4 ssd.large
openstack flavor set --property aggregate_instance_extra_specs:ssd=true ssd.large
```

4. Tạo VM trên các AZ vừa tạo
```sh
openstack server create --flavor m1.small --image Cirros --nic net-id=37b9ab9a-f198-4db1-a5d6-5789b05bfb4c --security-group f8dda7c3-f7c3-423b-923a-2b21fe0bbf3c --key-name mykey --availability-zone production-az vm-1
```
## Tài liệu tham khảo
- https://www.linuxtechi.com/create-availability-zones-openstack-command-line/
